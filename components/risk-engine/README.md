# FastAPI Skeleton

[![Built with FastAPI](https://img.shields.io/badge/Built_with-FastAPI-teal)](https://fastapi.tiangolo.com)

This is a FastAPI skeleton repo used as a reference for our code structure.

## Prerequisites

- Docker and Docker Compose
- Python 3.12

## Docker Setup

``` bash
1. Create .env file and copy the values from .env.example [FOR NOW THIS IS NOT BEING USED]

2. Run: docker-compose up -d
```

## Pre-commit Setup

[pre-commit](https://pre-commit.com/) used for code formatting and linting

```bash
1. Install pre-commit: pip install pre-commit
2. Run: pre-commit install
```

## Run Manually(NOT RECOMMENDED)

```bash
python -m venv .venv
.venv\Scripts\activate
pip install poetry
poetry install
uvicorn src.main:app --reload
```

## Alembic for Database migration

```bash
docker compose -f docker/docker-compose.yml run --rm fastapi-template alembic revision --autogenerate -m "Initial migration"

docker compose -f docker/docker-compose.yml run --rm fastapi-template alembic upgrade head
```

## Run Unit Tests

```bash
docker compose -f docker/docker-compose.yml run --rm fastapi-template pytest
```

## Run Coverage

```bash
docker compose -f docker/docker-compose.yml run --rm fastapi-template python -m pytest --cov=src tests/
```

## Get Detailed Coverage Report

```bash
docker compose -f docker/docker-compose.yml run --rm fastapi-template coverage html
```

Then open `htmlcov/index.html` in your browser

## API Documentation

```txt
http://localhost:5001/api/risk/docs
http://localhost:5001/api/risk/redoc
```

## Skeleton Structure

# Project Overview

This project is structured to maintain a clean, modular, and scalable architecture. The primary objective is to expose
APIs using the FastAPI framework, integrate machine learning models, and provide a robust backend system. Below is an
exhaustive explanation of the folder structure and the flow of how different components interact.

## Folder Structure

```plaintext
├── config                      # Configuration files for the project settings and environment
│   ├── __init__.py
│   ├── settings.py
│   └── settings.toml
├── pydocs                      # Autogenerated documentation via Sphinx
│   ├── build
│   ├── source
├── resources                   # Static files such as ML models and CSV files
│   ├── data
│   ├── models
├── src                         # Core application logic
│   ├── adapters                # Handles external API calls
│   │   └── external
│   ├── api                     # Exposes APIs via FastAPI
│   │   ├── routers             # Individual API routes
│   │   └── routes.py           # Combines all routers and serves them via FastAPI
│   ├── config                  # Configuration files for logging and database
│   ├── exceptions              # Custom application exceptions
│   ├── middlewares             # Middleware for various purposes like authentication, database connection, etc.
│   ├── ml                      # Machine learning models
│   │   └── models
│   ├── models                  # SQLAlchemy database models
│   ├── repositories            # Data Access Object (DAO) layer for accessing data
│   ├── schemas                 # Pydantic schemas for data validation and serialization
│   ├── services                # Contains business logic
│   ├── utils                   # Utility functions and helpers
│   └── __init__.py
├── tests                       # Various tests for the application
│   ├── integration
│   ├── performance
│   ├── security
│   ├── unit
│   │   └── utils
├── .dockerignore               # Files to ignore in Docker builds
├── .DS_Store                   # Metadata file (macOS)
├── .env.example                # Example environment variables file
├── .gitignore                  # Files to ignore in Git
├── .pre-commit-config.yaml     # Pre-commit hook configuration
├── app.py                      # Main application entry point (Server)
├── docker-compose.yml          # Docker Compose configuration
├── Dockerfile                  # Docker build configuration
├── pyproject.toml              # Project configuration file
├── README.md                   # Project documentation (this file)
└── requirements.txt            # Python dependencies
```

## Project Flow

1. **API Request**: An API request is made to the FastAPI application.
2. **Routing**: The request is routed to the appropriate endpoint defined in the `src/api/routers` directory.
3. **Middleware**: Middleware processes the request for authentication, database connection, etc.
4. **Service Layer**: The request is handled by the service layer in the `src/services` directory, where the business
   logic resides.
5. **Repository Layer**: If data access is needed, the service calls the repository layer in the `src/repositories`
   directory.
6. **Model Interaction**: The repository interacts with SQLAlchemy models in the `src/models` directory for database
   operations.
7. **Machine Learning**: If machine learning processing is required, the service interacts with ML models in
   the `src/ml/models` directory.
8. **Response**: The processed data is validated using Pydantic schemas in the `src/schemas` directory and sent back as
   a response.

## Example Flow Scoring

1. **API is triggered**: An API request is made to the `/scoring` endpoint.
2. **Router**: The request is routed to `src/api/routers/scoring.py`.
3. **Middleware**: All Middlewares being triggered.
4. **Service Call**: `ScoringService` in `src/services/scoring_service.py` is called.
5. **ML Call**: `FeatureStoreModel` in `src/ml/models/feature_store_model.py` is called.
6. **ML Call**: `IncomeModel` in `src/ml/models/income_model.py` is called.
7. **ML Call**: `PDModel` in `src/ml/models/pd_model.py` is called.
8. **ML Call**: `CalculationCenterModel` in `src/ml/models/calculation_center_model.py` is called.
9. **Response**: Data is validated using `CreditScoreOutput` in `src/schemas/credit_score.py` and returned to the
   client.

## Example Flow Model

1. **API is triggered**: An API request is made to the `/models` endpoint.
2. **Router**: The request is routed to `src/api/routers/models.py`.
3. **Middleware**: All Middlewares being triggered.
4. **Service Call**: `ModelService` in `src/services/model_service.py` is called.
5. **Repository Call**: `ModelRepository` in `src/repositories/model_repository.py` accesses the database.
6. **Database Interaction**: `Model` in `src/models/model.py` performs the database operation.
7. **Response**: Data is validated using `ModelRead` in `src/schemas/model.py` and returned to the client.

# Generate Code Documentation
```bash
pip3 install -r requirements-dev.txt

sphinx-build -b html pydocs/source pydocs/build

navigate to pydocs/build/index.html in your browser
```